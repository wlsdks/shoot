package com.stark.shoot.application.service.message.reaction

import org.junit.jupiter.api.Disabled
import com.stark.shoot.adapter.`in`.rest.dto.message.reaction.ReactionResponse
import com.stark.shoot.application.port.`in`.message.reaction.command.ToggleMessageReactionCommand
import com.stark.shoot.application.port.out.event.EventPublishPort
import com.stark.shoot.application.port.out.message.MessageCommandPort
import com.stark.shoot.application.port.out.message.MessageQueryPort
import com.stark.shoot.domain.chat.message.ChatMessage
import com.stark.shoot.domain.chat.message.service.MessageReactionService
import com.stark.shoot.domain.chat.message.type.MessageStatus
import com.stark.shoot.domain.chat.message.type.MessageType
import com.stark.shoot.domain.chat.message.vo.MessageContent
import com.stark.shoot.domain.chat.message.vo.MessageId
import com.stark.shoot.domain.chat.message.vo.ReactionToggleResult
import com.stark.shoot.domain.chat.reaction.type.ReactionType
import com.stark.shoot.domain.chat.reaction.vo.MessageReactions
import com.stark.shoot.domain.chat.vo.ChatRoomId
import com.stark.shoot.domain.shared.UserId
import com.stark.shoot.infrastructure.exception.web.InvalidInputException
import com.stark.shoot.infrastructure.exception.web.ResourceNotFoundException
import org.assertj.core.api.Assertions.assertThat
import org.junit.jupiter.api.BeforeEach
import org.junit.jupiter.api.DisplayName
import org.junit.jupiter.api.Nested
import org.junit.jupiter.api.Test
import org.junit.jupiter.api.assertThrows
import org.mockito.Mockito.*
import org.mockito.stubbing.Answer
import com.stark.shoot.adapter.`in`.socket.WebSocketMessageBroker
import org.mockito.ArgumentMatchers
import java.time.Instant

/**
 * TODO: MessageReaction Aggregate 분리로 인한 재작성 필요
 *
 * 변경사항:
 * - MessageReactionCommandPort, MessageReactionQueryPort 의존성 추가
 * - ChatMessage에서 toggleReaction() 메서드 제거됨
 * - 새로운 로직으로 테스트 재작성 필요
 */
@Disabled("MessageReaction Aggregate 분리로 인한 재작성 필요")
@DisplayName("메시지 리액션 토글 서비스 테스트")
class ToggleMessageReactionServiceTest {

    // Kotlin에서 Mockito any() 사용을 위한 헬퍼 함수
    private fun <T> any(): T {
        ArgumentMatchers.any<T>()
        @Suppress("UNCHECKED_CAST")
        return null as T
    }

    private val messageQueryPort = mock(MessageQueryPort::class.java)
    private val messageCommandPort = mock(MessageCommandPort::class.java)
    private val webSocketMessageBroker = mock(WebSocketMessageBroker::class.java)
    private val eventPublisher = mock(EventPublishPort::class.java)
    private val messageReactionService = mock(MessageReactionService::class.java)

    // RedisLockManager를 위한 모킹: 실제 동작하도록 람다를 즉시 실행
    private val redisLockManager = object : com.stark.shoot.infrastructure.config.redis.RedisLockManager(
        mock(org.springframework.data.redis.core.StringRedisTemplate::class.java),
        mock(com.stark.shoot.infrastructure.config.redis.RedisLockProperties::class.java)
    ) {
        override fun <T> withLock(
            lockKey: String,
            ownerId: String,
            retryCount: Int,
            autoExtend: Boolean,
            action: () -> T
        ): T = action()
    }

    private val toggleMessageReactionService = ToggleMessageReactionService(
        messageQueryPort,
        messageCommandPort,
        webSocketMessageBroker,
        eventPublisher,
        messageReactionService,
        redisLockManager
    )

    @Nested
    @DisplayName("메시지 리액션 토글 시")
    inner class ToggleReaction {

        @Test
        @DisplayName("[happy] 유효한 리액션 타입으로 리액션을 추가할 수 있다")
        fun `유효한 리액션 타입으로 리액션을 추가할 수 있다`() {
            // given
            val messageIdStr = "5f9f1b9b9c9d1b9b9c9d1b9b"
            val messageId = MessageId.from(messageIdStr)
            val userIdLong = 1L
            val userId = UserId.from(userIdLong)
            val reactionType = "like"
            val roomIdLong = 1L
            val roomId = ChatRoomId.from(roomIdLong)
            val now = Instant.now()

            val initialReactions = mapOf<String, Set<Long>>()
            val updatedReactions = mapOf(reactionType to setOf(userIdLong))

            val message = ChatMessage(
                id = messageId,
                roomId = roomId,
                senderId = UserId.from(2L),
                content = MessageContent("테스트 메시지", MessageType.TEXT),
                status = MessageStatus.SENT,
                messageReactions = MessageReactions(initialReactions),
                createdAt = now,
                updatedAt = now
            )

            val updatedMessage = message.copy(
                messageReactions = MessageReactions(updatedReactions),
                updatedAt = now
            )

            val toggleResult = ReactionToggleResult(
                reactions = MessageReactions(updatedReactions),
                message = updatedMessage,
                userId = userId,
                reactionType = reactionType,
                isAdded = true,
                previousReactionType = null,
                isReplacement = false
            )

            val savedMessage = updatedMessage.copy()

            val expectedResponse = ReactionResponse.from(
                messageId = savedMessage.id?.value ?: messageIdStr,
                reactions = savedMessage.reactions,
                updatedAt = savedMessage.updatedAt?.toString() ?: ""
            )

            `when`(messageQueryPort.findById(messageId)).thenReturn(message)
            `when`(messageCommandPort.save(any())).thenReturn(savedMessage)

            // when
            val command = ToggleMessageReactionCommand(messageId, userId, reactionType)
            val result = toggleMessageReactionService.toggleReaction(command)

            // then
            assertThat(result.messageId).isEqualTo(messageIdStr)
            assertThat(result.reactions).isNotEmpty

            verify(messageQueryPort).findById(messageId)
            verify(messageCommandPort).save(any())
        }

        @Test
        @DisplayName("[bad] 존재하지 않는 메시지 ID로 토글하면 예외가 발생한다")
        fun `존재하지 않는 메시지 ID로 토글하면 예외가 발생한다`() {
            // given
            val messageIdStr = "5f9f1b9b9c9d1b9b9c9d1b9b"
            val messageId = MessageId.from(messageIdStr)
            val userIdLong = 1L
            val userId = UserId.from(userIdLong)
            val reactionType = "like"

            `when`(messageQueryPort.findById(messageId)).thenReturn(null)

            // when & then
            val command = ToggleMessageReactionCommand(messageId, userId, reactionType)
            assertThrows<ResourceNotFoundException> {
                toggleMessageReactionService.toggleReaction(command)
            }

            verify(messageQueryPort).findById(messageId)
            verifyNoInteractions(messageCommandPort)
        }

        @Test
        @DisplayName("[bad] 지원하지 않는 리액션 타입으로 토글하면 예외가 발생한다")
        fun `지원하지 않는 리액션 타입으로 토글하면 예외가 발생한다`() {
            // given
            val messageIdStr = "5f9f1b9b9c9d1b9b9c9d1b9b"
            val messageId = MessageId.from(messageIdStr)
            val userIdLong = 1L
            val userId = UserId.from(userIdLong)
            val invalidReactionType = "invalid_type"

            // when & then
            val command = ToggleMessageReactionCommand(messageId, userId, invalidReactionType)
            assertThrows<InvalidInputException> {
                toggleMessageReactionService.toggleReaction(command)
            }

            verifyNoInteractions(messageQueryPort)
            verifyNoInteractions(messageCommandPort)
        }
    }
}
